# Comparing `tmp/inmanta_module_podman-0.4.1-py3-none-any.whl.zip` & `tmp/inmanta_module_podman-0.4.2-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,25 +1,25 @@
-Zip file size: 29173 bytes, number of entries: 23
--rw-r--r--  2.0 unx    10417 b- defN 24-May-09 12:45 inmanta_plugins/podman/__init__.py
--rw-r--r--  2.0 unx     2224 b- defN 24-May-09 12:45 inmanta_plugins/podman/setup.cfg
--rw-r--r--  2.0 unx        0 b- defN 24-May-09 12:45 inmanta_plugins/podman/files/.gitkeep
--rw-r--r--  2.0 unx     7388 b- defN 24-May-09 12:45 inmanta_plugins/podman/model/_init.cf
--rw-r--r--  2.0 unx     1841 b- defN 24-May-09 12:45 inmanta_plugins/podman/model/container.cf
--rw-r--r--  2.0 unx     5256 b- defN 24-May-09 12:45 inmanta_plugins/podman/model/container_like.cf
--rw-r--r--  2.0 unx     2345 b- defN 24-May-09 12:45 inmanta_plugins/podman/model/helpers.cf
--rw-r--r--  2.0 unx     1066 b- defN 24-May-09 12:45 inmanta_plugins/podman/model/network.cf
--rw-r--r--  2.0 unx     2560 b- defN 24-May-09 12:45 inmanta_plugins/podman/model/services/_init.cf
--rw-r--r--  2.0 unx     3906 b- defN 24-May-09 12:45 inmanta_plugins/podman/model/services/systemd_container.cf
--rw-r--r--  2.0 unx     3666 b- defN 24-May-09 12:45 inmanta_plugins/podman/model/services/systemd_pod.cf
--rw-r--r--  2.0 unx     5635 b- defN 24-May-09 12:45 inmanta_plugins/podman/model/services/systemd_service.cf
--rw-r--r--  2.0 unx      646 b- defN 24-May-09 12:45 inmanta_plugins/podman/resources/__init__.py
--rw-r--r--  2.0 unx     3059 b- defN 24-May-09 12:45 inmanta_plugins/podman/resources/abc.py
--rw-r--r--  2.0 unx     8073 b- defN 24-May-09 12:45 inmanta_plugins/podman/resources/image.py
--rw-r--r--  2.0 unx     3208 b- defN 24-May-09 12:45 inmanta_plugins/podman/resources/image_discovery.py
--rw-r--r--  2.0 unx     8616 b- defN 24-May-09 12:45 inmanta_plugins/podman/resources/network.py
--rw-r--r--  2.0 unx     2915 b- defN 24-May-09 12:45 inmanta_plugins/podman/resources/network_discovery.py
--rw-r--r--  2.0 unx        0 b- defN 24-May-09 12:45 inmanta_plugins/podman/templates/.gitkeep
--rw-r--r--  2.0 unx      821 b- defN 24-May-09 12:45 inmanta_module_podman-0.4.1.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 24-May-09 12:45 inmanta_module_podman-0.4.1.dist-info/WHEEL
--rw-r--r--  2.0 unx       16 b- defN 24-May-09 12:45 inmanta_module_podman-0.4.1.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     2259 b- defN 24-May-09 12:45 inmanta_module_podman-0.4.1.dist-info/RECORD
-23 files, 76009 bytes uncompressed, 25377 bytes compressed:  66.6%
+Zip file size: 29575 bytes, number of entries: 23
+-rw-r--r--  2.0 unx    10417 b- defN 24-May-16 19:33 inmanta_plugins/podman/__init__.py
+-rw-r--r--  2.0 unx     2224 b- defN 24-May-16 19:33 inmanta_plugins/podman/setup.cfg
+-rw-r--r--  2.0 unx        0 b- defN 24-May-16 19:33 inmanta_plugins/podman/files/.gitkeep
+-rw-r--r--  2.0 unx     7388 b- defN 24-May-16 19:33 inmanta_plugins/podman/model/_init.cf
+-rw-r--r--  2.0 unx     1841 b- defN 24-May-16 19:33 inmanta_plugins/podman/model/container.cf
+-rw-r--r--  2.0 unx     5256 b- defN 24-May-16 19:33 inmanta_plugins/podman/model/container_like.cf
+-rw-r--r--  2.0 unx     2345 b- defN 24-May-16 19:33 inmanta_plugins/podman/model/helpers.cf
+-rw-r--r--  2.0 unx     1066 b- defN 24-May-16 19:33 inmanta_plugins/podman/model/network.cf
+-rw-r--r--  2.0 unx     2560 b- defN 24-May-16 19:33 inmanta_plugins/podman/model/services/_init.cf
+-rw-r--r--  2.0 unx     3906 b- defN 24-May-16 19:33 inmanta_plugins/podman/model/services/systemd_container.cf
+-rw-r--r--  2.0 unx     3666 b- defN 24-May-16 19:33 inmanta_plugins/podman/model/services/systemd_pod.cf
+-rw-r--r--  2.0 unx     5635 b- defN 24-May-16 19:33 inmanta_plugins/podman/model/services/systemd_service.cf
+-rw-r--r--  2.0 unx      646 b- defN 24-May-16 19:33 inmanta_plugins/podman/resources/__init__.py
+-rw-r--r--  2.0 unx     3059 b- defN 24-May-16 19:33 inmanta_plugins/podman/resources/abc.py
+-rw-r--r--  2.0 unx     9538 b- defN 24-May-16 19:33 inmanta_plugins/podman/resources/image.py
+-rw-r--r--  2.0 unx     3208 b- defN 24-May-16 19:33 inmanta_plugins/podman/resources/image_discovery.py
+-rw-r--r--  2.0 unx     8616 b- defN 24-May-16 19:33 inmanta_plugins/podman/resources/network.py
+-rw-r--r--  2.0 unx     2915 b- defN 24-May-16 19:33 inmanta_plugins/podman/resources/network_discovery.py
+-rw-r--r--  2.0 unx        0 b- defN 24-May-16 19:33 inmanta_plugins/podman/templates/.gitkeep
+-rw-r--r--  2.0 unx      821 b- defN 24-May-16 19:33 inmanta_module_podman-0.4.2.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 24-May-16 19:33 inmanta_module_podman-0.4.2.dist-info/WHEEL
+-rw-r--r--  2.0 unx       16 b- defN 24-May-16 19:33 inmanta_module_podman-0.4.2.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     2259 b- defN 24-May-16 19:33 inmanta_module_podman-0.4.2.dist-info/RECORD
+23 files, 77474 bytes uncompressed, 25779 bytes compressed:  66.7%
```

## zipnote {}

```diff
@@ -51,20 +51,20 @@
 
 Filename: inmanta_plugins/podman/resources/network_discovery.py
 Comment: 
 
 Filename: inmanta_plugins/podman/templates/.gitkeep
 Comment: 
 
-Filename: inmanta_module_podman-0.4.1.dist-info/METADATA
+Filename: inmanta_module_podman-0.4.2.dist-info/METADATA
 Comment: 
 
-Filename: inmanta_module_podman-0.4.1.dist-info/WHEEL
+Filename: inmanta_module_podman-0.4.2.dist-info/WHEEL
 Comment: 
 
-Filename: inmanta_module_podman-0.4.1.dist-info/top_level.txt
+Filename: inmanta_module_podman-0.4.2.dist-info/top_level.txt
 Comment: 
 
-Filename: inmanta_module_podman-0.4.1.dist-info/RECORD
+Filename: inmanta_module_podman-0.4.2.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## inmanta_plugins/podman/setup.cfg

```diff
@@ -1,10 +1,10 @@
 [metadata]
 name = inmanta-module-podman
-version = 0.4.1
+version = 0.4.2
 description = Simple module to manage podman resources
 long_description = file: README.md
 long_description_content_type = text/markdown
 author = Guillaume Everarts de Velp
 author_email = edvgui@gmail.com
 license = ASL 2.0
 copyright = 2023 Guillaume Everarts de Velp
```

## inmanta_plugins/podman/resources/image.py

```diff
@@ -23,16 +23,28 @@
 import inmanta.const
 import inmanta.execute.proxy
 import inmanta.export
 import inmanta.resources
 import inmanta_plugins.podman.resources.abc
 
 
+def valid_digest(digest: str, repo_digests: list[str]) -> bool:
+    """
+    Check if the given digest value is a match for one of the repo digests
+    entries.  The format of the repo digests is <repository>:<tag>@<digest>
+
+    :param digest: The digest to validate
+    :param repo_digests: The list of repo digest to compare it to
+    """
+    return digest in [repo_digest.split("@")[-1] for repo_digest in repo_digests]
+
+
 class ImageResource(inmanta_plugins.podman.resources.abc.ResourceABC):
-    pass
+    fields = ("digest",)
+    digest: str | None
 
 
 IR = typing.TypeVar("IR", bound=ImageResource)
 
 
 class ImageHandler(
     inmanta_plugins.podman.resources.abc.HandlerABC[IR],
@@ -64,14 +76,29 @@
                 exit_code=ret,
                 stderr=stderr,
             )
             raise RuntimeError("Failed to inspect image")
 
         return json.loads(stdout)[0]
 
+    def calculate_diff(
+        self,
+        ctx: inmanta.agent.handler.HandlerContext,
+        current: IR,
+        desired: IR,
+    ) -> dict[str, dict[str, typing.Any]]:
+        changes = super().calculate_diff(ctx, current, desired)
+
+        if not changes and desired.digest is None:
+            # When there is no change and there is no desired digest, force the detection
+            # of a change by including the digest in the diff
+            changes["digest"] = {"current": current.digest, "desired": None}
+
+        return changes
+
     def delete_resource(
         self,
         ctx: inmanta.agent.handler.HandlerContext,
         resource: IR,
     ) -> None:
         # Run the remove command on the remote host
         command = ["podman", "image", "rm", resource.name]
@@ -123,32 +150,41 @@
             options.append("--squash-all")
         if entity.pull:
             options.append(f"--pull={entity.pull}")
         if entity.file:
             options.append(f"--file={entity.file}")
         return options
 
+    @classmethod
+    def get_digest(
+        cls,
+        exporter: inmanta.export.Exporter,
+        entity: inmanta.execute.proxy.DynamicProxy,
+    ) -> None:
+        """
+        The digest can't be known before building the image, so we just
+        return None
+        """
+        return None
+
 
 @inmanta.agent.handler.provider("podman::ImageFromSource", "")
 class ImageFromSourceHandler(ImageHandler[ImageFromSourceResource]):
     def read_resource(
         self,
         ctx: inmanta.agent.handler.HandlerContext,
         resource: ImageFromSourceResource,
     ) -> None:
         try:
             existing_image = self.inspect_image(ctx, resource)
         except LookupError:
             # The image was not found
             raise inmanta.agent.handler.ResourcePurged()
 
-        # Always detect changes, we have no way to know if our image is up to date
-        resource.options = None
-
-        ctx.set("current_digest", existing_image["Digest"])
+        resource.digest = existing_image["Digest"]
 
     def build_image(
         self,
         ctx: inmanta.agent.handler.HandlerContext,
         resource: ImageFromSourceResource,
     ) -> None:
         # Create build command
@@ -191,16 +227,19 @@
         self,
         ctx: inmanta.agent.handler.HandlerContext,
         changes: dict[str, dict[str, object]],
         resource: ImageFromSourceResource,
     ) -> None:
         self.build_image(ctx, resource)
 
-        if ctx.get("current_digest") != self.inspect_image(ctx, resource)["Digest"]:
-            # If digest didn't change, the image was not updated, the rebuild was a noop
+        if not valid_digest(
+            changes["digest"]["current"],
+            self.inspect_image(ctx, resource)["RepoDigests"],
+        ):
+            # If the digest has changed, we have a different image
             ctx.set_updated()
 
 
 @inmanta.resources.resource(
     name="podman::ImageFromRegistry",
     id_attribute="q",
     agent="host.name",
@@ -220,15 +259,18 @@
     ) -> None:
         try:
             existing_image = self.inspect_image(ctx, resource)
         except LookupError:
             # The image was not found
             raise inmanta.agent.handler.ResourcePurged()
 
-        resource.digest = existing_image["Digest"]
+        if not valid_digest(resource.digest, existing_image["RepoDigests"]):
+            # Only detect a different digest if the desired digest (which may be None)
+            # is not part of the image ones
+            resource.digest = existing_image["Digest"]
 
     def pull_image(
         self,
         ctx: inmanta.agent.handler.HandlerContext,
         resource: ImageFromRegistryResource,
     ) -> None:
         # Compose image source
@@ -267,10 +309,13 @@
         self,
         ctx: inmanta.agent.handler.HandlerContext,
         changes: dict[str, dict[str, object]],
         resource: ImageFromRegistryResource,
     ) -> None:
         self.pull_image(ctx, resource)
 
-        if changes["digest"]["current"] != self.inspect_image(ctx, resource)["Digest"]:
-            # If digest didn't change, the image was not updated, the pull was a noop
+        if not valid_digest(
+            changes["digest"]["current"],
+            self.inspect_image(ctx, resource)["RepoDigests"],
+        ):
+            # If the digest has changed, we have a different image
             ctx.set_updated()
```

## Comparing `inmanta_module_podman-0.4.1.dist-info/METADATA` & `inmanta_module_podman-0.4.2.dist-info/METADATA`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: inmanta-module-podman
-Version: 0.4.1
+Version: 0.4.2
 Summary: Simple module to manage podman resources
 Author: Guillaume Everarts de Velp
 Author-email: edvgui@gmail.com
 License: ASL 2.0
 Description-Content-Type: text/markdown
 Requires-Dist: inmanta-module-std <6,>=4.0
 Requires-Dist: inmanta-module-exec <2,>=1.1
```

## Comparing `inmanta_module_podman-0.4.1.dist-info/RECORD` & `inmanta_module_podman-0.4.2.dist-info/RECORD`

 * *Files 10% similar despite different names*

```diff
@@ -1,23 +1,23 @@
 inmanta_plugins/podman/__init__.py,sha256=mZd53TyEBqx_fsfSTSlSiR4F24725fwaBsTCa546KnE,10417
-inmanta_plugins/podman/setup.cfg,sha256=32aaYmjEBIrlz9q6z9cfQDLJlrfVTCjy7NEeyvoDYfk,2224
+inmanta_plugins/podman/setup.cfg,sha256=zCEP3mKEUuX6y7IZss8008ZL_Xd-S1yCeKhHUudh8-c,2224
 inmanta_plugins/podman/files/.gitkeep,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 inmanta_plugins/podman/model/_init.cf,sha256=9v-fV9VIO2T80i05u7VXsJ0mnp_xNCLWZlrxYl8mYxo,7388
 inmanta_plugins/podman/model/container.cf,sha256=-GDpwZcNcskQUwxUap8Vjs9OqkLlhXJioWeoqjlK33g,1841
 inmanta_plugins/podman/model/container_like.cf,sha256=4QFxX9jOkNV417h89kh5DW-QLO0VyGDxXDG9IDRgQu4,5256
 inmanta_plugins/podman/model/helpers.cf,sha256=_aQ5OWhJ5gbPKV34FdIyR-_Rs4YlKu-C2A9rXTWZRmA,2345
 inmanta_plugins/podman/model/network.cf,sha256=nHluWQn-9b04IM8HpxgihKg_jhTUPyfKP5h4CStQ7MY,1066
 inmanta_plugins/podman/model/services/_init.cf,sha256=ZoPTYN4yJKHzgddg0x8qhjFb9EzM19D72X7FrV7JJ98,2560
 inmanta_plugins/podman/model/services/systemd_container.cf,sha256=48ynfEZTJlSh0C6cdKpGOKWeeLJVlt4mvvZ3qxb6oTQ,3906
 inmanta_plugins/podman/model/services/systemd_pod.cf,sha256=WZa_UEMjaTx-L6qVCdwKk1BSogFZW1dWv8qbl5Cum8Q,3666
 inmanta_plugins/podman/model/services/systemd_service.cf,sha256=5W9EE4wdvnk8oCPO8UzF7kZN8R8C1fJ4vgzzGwWMhb4,5635
 inmanta_plugins/podman/resources/__init__.py,sha256=NVBEWheGn8M9YTpErdDAYodvUfapWtad4ys81s9KUNs,646
 inmanta_plugins/podman/resources/abc.py,sha256=4tZqTP6nYHMd5ar2Vi8M9xED0pRRu7JMhbkba3ELL14,3059
-inmanta_plugins/podman/resources/image.py,sha256=vmgYqp3bKShyiZKLWcczEXbvvwdW5ZCtc4W1wSktILE,8073
+inmanta_plugins/podman/resources/image.py,sha256=zdxZUZnWj_RyAlqbF9X4RljTt2MnSMC58343cN3XDjI,9538
 inmanta_plugins/podman/resources/image_discovery.py,sha256=D7ziB25nwobV73E-Geq7suz5qef-AcR7FV3O9Sxw-2E,3208
 inmanta_plugins/podman/resources/network.py,sha256=6TkRhNOksstoorN-w3lN1BvIsRzHru9JsHieefy9qYk,8616
 inmanta_plugins/podman/resources/network_discovery.py,sha256=4_i5EgU_ieoNPL8iOKEIKxd9hf4fGzwOItJxIPjLBvQ,2915
 inmanta_plugins/podman/templates/.gitkeep,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-inmanta_module_podman-0.4.1.dist-info/METADATA,sha256=QP1ebkurQxOgagA2X_OHg0XVsuFRh03lM27LgXMLmX8,821
-inmanta_module_podman-0.4.1.dist-info/WHEEL,sha256=GJ7t_kWBFywbagK5eo9IoUwLW6oyOeTKmQ-9iHFVNxQ,92
-inmanta_module_podman-0.4.1.dist-info/top_level.txt,sha256=rb9c6eWQS8KFuSa3ktEcXpk-oSsCL9ZCVAgv7S0Eg_w,16
-inmanta_module_podman-0.4.1.dist-info/RECORD,,
+inmanta_module_podman-0.4.2.dist-info/METADATA,sha256=8Jd1edM-91Y-95LF59OwPvXMvF5IRzDLwFNh-IK1ews,821
+inmanta_module_podman-0.4.2.dist-info/WHEEL,sha256=GJ7t_kWBFywbagK5eo9IoUwLW6oyOeTKmQ-9iHFVNxQ,92
+inmanta_module_podman-0.4.2.dist-info/top_level.txt,sha256=rb9c6eWQS8KFuSa3ktEcXpk-oSsCL9ZCVAgv7S0Eg_w,16
+inmanta_module_podman-0.4.2.dist-info/RECORD,,
```

