# Comparing `tmp/karton_core-5.3.3-py3-none-any.whl.zip` & `tmp/karton_core-5.3.4-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,28 +1,28 @@
-Zip file size: 47110 bytes, number of entries: 26
--rw-r--r--  2.0 unx      539 b- defN 24-Feb-07 15:20 karton_core-5.3.3-nspkg.pth
--rw-r--r--  2.0 unx      337 b- defN 24-Feb-07 15:20 karton/core/__init__.py
--rw-r--r--  2.0 unx       22 b- defN 24-Feb-07 15:20 karton/core/__version__.py
--rw-r--r--  2.0 unx    34696 b- defN 24-Feb-07 15:20 karton/core/backend.py
--rw-r--r--  2.0 unx     8083 b- defN 24-Feb-07 15:20 karton/core/base.py
--rw-r--r--  2.0 unx     8118 b- defN 24-Feb-07 15:20 karton/core/config.py
--rw-r--r--  2.0 unx      153 b- defN 24-Feb-07 15:20 karton/core/exceptions.py
--rw-r--r--  2.0 unx     4868 b- defN 24-Feb-07 15:20 karton/core/inspect.py
--rw-r--r--  2.0 unx    14863 b- defN 24-Feb-07 15:20 karton/core/karton.py
--rw-r--r--  2.0 unx     2040 b- defN 24-Feb-07 15:20 karton/core/logger.py
--rw-r--r--  2.0 unx     8310 b- defN 24-Feb-07 15:20 karton/core/main.py
--rw-r--r--  2.0 unx        0 b- defN 24-Feb-07 15:20 karton/core/py.typed
--rw-r--r--  2.0 unx    20321 b- defN 24-Feb-07 15:20 karton/core/resource.py
--rw-r--r--  2.0 unx    19644 b- defN 24-Feb-07 15:20 karton/core/task.py
--rw-r--r--  2.0 unx     9102 b- defN 24-Feb-07 15:20 karton/core/test.py
--rw-r--r--  2.0 unx     4090 b- defN 24-Feb-07 15:20 karton/core/utils.py
--rw-r--r--  2.0 unx       63 b- defN 24-Feb-07 15:20 karton/system/__init__.py
--rw-r--r--  2.0 unx       56 b- defN 24-Feb-07 15:20 karton/system/__main__.py
--rw-r--r--  2.0 unx    13791 b- defN 24-Feb-07 15:20 karton/system/system.py
--rw-r--r--  2.0 unx     1519 b- defN 24-Feb-07 15:20 karton_core-5.3.3.dist-info/LICENSE
--rw-r--r--  2.0 unx     6847 b- defN 24-Feb-07 15:20 karton_core-5.3.3.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 24-Feb-07 15:20 karton_core-5.3.3.dist-info/WHEEL
--rw-r--r--  2.0 unx       99 b- defN 24-Feb-07 15:20 karton_core-5.3.3.dist-info/entry_points.txt
--rw-r--r--  2.0 unx        7 b- defN 24-Feb-07 15:20 karton_core-5.3.3.dist-info/namespace_packages.txt
--rw-r--r--  2.0 unx        7 b- defN 24-Feb-07 15:20 karton_core-5.3.3.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     2104 b- defN 24-Feb-07 15:20 karton_core-5.3.3.dist-info/RECORD
-26 files, 159771 bytes uncompressed, 43726 bytes compressed:  72.6%
+Zip file size: 47415 bytes, number of entries: 26
+-rw-r--r--  2.0 unx      539 b- defN 24-Mar-26 13:47 karton_core-5.3.4-nspkg.pth
+-rw-r--r--  2.0 unx      337 b- defN 24-Mar-26 13:47 karton/core/__init__.py
+-rw-r--r--  2.0 unx       22 b- defN 24-Mar-26 13:47 karton/core/__version__.py
+-rw-r--r--  2.0 unx    34696 b- defN 24-Mar-26 13:47 karton/core/backend.py
+-rw-r--r--  2.0 unx     8083 b- defN 24-Mar-26 13:47 karton/core/base.py
+-rw-r--r--  2.0 unx     8118 b- defN 24-Mar-26 13:47 karton/core/config.py
+-rw-r--r--  2.0 unx      153 b- defN 24-Mar-26 13:47 karton/core/exceptions.py
+-rw-r--r--  2.0 unx     4868 b- defN 24-Mar-26 13:47 karton/core/inspect.py
+-rw-r--r--  2.0 unx    15007 b- defN 24-Mar-26 13:47 karton/core/karton.py
+-rw-r--r--  2.0 unx     2040 b- defN 24-Mar-26 13:47 karton/core/logger.py
+-rw-r--r--  2.0 unx     8310 b- defN 24-Mar-26 13:47 karton/core/main.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-26 13:47 karton/core/py.typed
+-rw-r--r--  2.0 unx    20321 b- defN 24-Mar-26 13:47 karton/core/resource.py
+-rw-r--r--  2.0 unx    21000 b- defN 24-Mar-26 13:47 karton/core/task.py
+-rw-r--r--  2.0 unx     9102 b- defN 24-Mar-26 13:47 karton/core/test.py
+-rw-r--r--  2.0 unx     4090 b- defN 24-Mar-26 13:47 karton/core/utils.py
+-rw-r--r--  2.0 unx       63 b- defN 24-Mar-26 13:47 karton/system/__init__.py
+-rw-r--r--  2.0 unx       56 b- defN 24-Mar-26 13:47 karton/system/__main__.py
+-rw-r--r--  2.0 unx    13787 b- defN 24-Mar-26 13:47 karton/system/system.py
+-rw-r--r--  2.0 unx     1519 b- defN 24-Mar-26 13:47 karton_core-5.3.4.dist-info/LICENSE
+-rw-r--r--  2.0 unx     6847 b- defN 24-Mar-26 13:47 karton_core-5.3.4.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 24-Mar-26 13:47 karton_core-5.3.4.dist-info/WHEEL
+-rw-r--r--  2.0 unx       99 b- defN 24-Mar-26 13:47 karton_core-5.3.4.dist-info/entry_points.txt
+-rw-r--r--  2.0 unx        7 b- defN 24-Mar-26 13:47 karton_core-5.3.4.dist-info/namespace_packages.txt
+-rw-r--r--  2.0 unx        7 b- defN 24-Mar-26 13:47 karton_core-5.3.4.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     2104 b- defN 24-Mar-26 13:47 karton_core-5.3.4.dist-info/RECORD
+26 files, 161267 bytes uncompressed, 44031 bytes compressed:  72.7%
```

## zipnote {}

```diff
@@ -1,8 +1,8 @@
-Filename: karton_core-5.3.3-nspkg.pth
+Filename: karton_core-5.3.4-nspkg.pth
 Comment: 
 
 Filename: karton/core/__init__.py
 Comment: 
 
 Filename: karton/core/__version__.py
 Comment: 
@@ -51,29 +51,29 @@
 
 Filename: karton/system/__main__.py
 Comment: 
 
 Filename: karton/system/system.py
 Comment: 
 
-Filename: karton_core-5.3.3.dist-info/LICENSE
+Filename: karton_core-5.3.4.dist-info/LICENSE
 Comment: 
 
-Filename: karton_core-5.3.3.dist-info/METADATA
+Filename: karton_core-5.3.4.dist-info/METADATA
 Comment: 
 
-Filename: karton_core-5.3.3.dist-info/WHEEL
+Filename: karton_core-5.3.4.dist-info/WHEEL
 Comment: 
 
-Filename: karton_core-5.3.3.dist-info/entry_points.txt
+Filename: karton_core-5.3.4.dist-info/entry_points.txt
 Comment: 
 
-Filename: karton_core-5.3.3.dist-info/namespace_packages.txt
+Filename: karton_core-5.3.4.dist-info/namespace_packages.txt
 Comment: 
 
-Filename: karton_core-5.3.3.dist-info/top_level.txt
+Filename: karton_core-5.3.4.dist-info/top_level.txt
 Comment: 
 
-Filename: karton_core-5.3.3.dist-info/RECORD
+Filename: karton_core-5.3.4.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## karton/core/__version__.py

```diff
@@ -1 +1 @@
-__version__ = "5.3.3"
+__version__ = "5.3.4"
```

## karton/core/karton.py

```diff
@@ -8,14 +8,15 @@
 import traceback
 from typing import Any, Callable, Dict, List, Optional, Tuple, cast
 
 from .__version__ import __version__
 from .backend import KartonBackend, KartonBind, KartonMetrics
 from .base import KartonBase, KartonServiceBase
 from .config import Config
+from .exceptions import TaskTimeoutError
 from .resource import LocalResource
 from .task import Task, TaskState
 from .utils import timeout
 
 
 class Producer(KartonBase):
     """
@@ -125,15 +126,18 @@
             self.config.getboolean("karton", "persistent", self.persistent)
             and not self.debug
         )
         self.task_timeout = self.config.getint("karton", "task_timeout")
         self.current_task: Optional[Task] = None
         self._pre_hooks: List[Tuple[Optional[str], Callable[[Task], None]]] = []
         self._post_hooks: List[
-            Tuple[Optional[str], Callable[[Task, Optional[Exception]], None]]
+            Tuple[
+                Optional[str],
+                Callable[[Task, Optional[BaseException]], None],
+            ]
         ] = []
 
     @abc.abstractmethod
     def process(self, task: Task) -> None:
         """
         Task processing method.
 
@@ -175,22 +179,22 @@
             saved_exception = None
             try:
                 if self.task_timeout:
                     with timeout(self.task_timeout):
                         self.process(self.current_task)
                 else:
                     self.process(self.current_task)
-            except Exception as exc:
+            except (Exception, TaskTimeoutError) as exc:
                 saved_exception = exc
                 raise
             finally:
                 self._run_post_hooks(saved_exception)
 
             self.log.info("Task done - %s", self.current_task.uid)
-        except Exception:
+        except (Exception, TaskTimeoutError):
             exc_info = sys.exc_info()
             exception_str = traceback.format_exception(*exc_info)
 
             self.backend.increment_metrics(KartonMetrics.TASK_CRASHED, self.identity)
             self.log.exception("Failed to process task - %s", self.current_task.uid)
         finally:
             self.backend.increment_metrics(KartonMetrics.TASK_CONSUMED, self.identity)
@@ -256,15 +260,15 @@
             is a :class:`karton.Task`
         :param name: Name of the pre-hook
         """
         self._pre_hooks.append((name, callback))
 
     def add_post_hook(
         self,
-        callback: Callable[[Task, Optional[Exception]], None],
+        callback: Callable[[Task, Optional[BaseException]], None],
         name: Optional[str] = None,
     ) -> None:
         """
         Add a function to be called after processing each task.
 
         :param callback: Function of the form ``callback(task, exception)``
             where ``task`` is a :class:`karton.Task` and ``exception`` is
@@ -285,15 +289,15 @@
                 callback(cast(Task, self.current_task))
             except Exception:
                 if name:
                     self.log.exception("Pre-hook (%s) failed", name)
                 else:
                     self.log.exception("Pre-hook failed")
 
-    def _run_post_hooks(self, exception: Optional[Exception]) -> None:
+    def _run_post_hooks(self, exception: Optional[BaseException]) -> None:
         """
         Run registered postprocessing hooks
 
         :param exception: Exception object that was caught while processing the task
 
         :meta private:
         """
@@ -427,15 +431,15 @@
         """Send a begin status signaling task.
 
         :meta private:
         """
         self._send_signaling_status_task("task_begin")
 
     def _send_signaling_status_task_end(
-        self, task: Task, ex: Optional[Exception]
+        self, task: Task, ex: Optional[BaseException]
     ) -> None:
         """Send a begin status signaling task.
 
         :meta private:
         """
         self._send_signaling_status_task("task_end")
```

## karton/core/task.py

```diff
@@ -208,46 +208,73 @@
 
         :param filters: Task header filters
         :return: True if task headers match specific filters
 
         :meta private:
         """
 
-        matches = False
-        for task_filter in filters:
-            matched = []
-            for filter_key, filter_value in task_filter.items():
-                # Coerce to string for comparison
-                header_value = self.headers.get(filter_key)
+        def test_filter(headers: Dict[str, Any], filter: Dict[str, Any]) -> int:
+            """
+            Filter match follows AND logic, but it's non-boolean because filters may be
+            negated (task:!platform).
+
+            Result values are as follows:
+            - 1  - positive match, no mismatched values in headers
+                   (all matched)
+            - 0  - no match, found value that doesn't match to the filter
+                   (some are not matched)
+            - -1 - negative match, found value that matches negated filter value
+                   (all matched but found negative matches)
+            """
+            matches = 1
+            for filter_key, filter_value in filter.items():
+                # Coerce filter value to string
                 filter_value_str = str(filter_value)
-                header_value_str = str(header_value)
-
                 negated = False
                 if filter_value_str.startswith("!"):
                     negated = True
                     filter_value_str = filter_value_str[1:]
 
-                if header_value is None:
-                    matched.append(negated)
-                    continue
+                # If expected key doesn't exist in headers
+                if filter_key not in headers:
+                    # Negated filter ignores non-existent values
+                    if negated:
+                        continue
+                    # But positive filter doesn't
+                    return 0
 
+                # Coerce header value to string
+                header_value_str = str(headers[filter_key])
                 # fnmatch is great for handling simple wildcard patterns (?, *, [abc])
                 match = fnmatch.fnmatchcase(header_value_str, filter_value_str)
-                # if matches, but it's negated then we can return straight away
-                # since no matter the other filters
+                # If matches, but it's negated: it's negative match
                 if match and negated:
-                    return False
-
-                # else, apply a XOR logic to take care of negation matching
-                matched.append(match != negated)
-
-            # set the flag if all consumer filter fields match the task header.
-            # It will be set to True only if at least one filter matches the header
-            matches |= all(matched)
-
+                    matches = -1
+                # If doesn't match but filter is not negated: it's not a match
+                if not match and not negated:
+                    return 0
+            # If there are no mismatched values: filter is matched
+            return matches
+
+        # List of filter matches follow OR logic, but -1 is special
+        # If there is any -1, result is False
+        #   (any matched, but it's negative match)
+        # If there is any 1, but no -1's: result is True
+        #   (any matched, no negative match)
+        # If there are only 0's: result is False
+        #   (none matched)
+        matches = False
+        for task_filter in filters:
+            match_result = test_filter(self.headers, task_filter)
+            if match_result == -1:
+                # Any negative match results in False
+                return False
+            if match_result == 1:
+                # Any positive match but without negative matches results in True
+                matches = True
         return matches
 
     def set_task_parent(self, parent: "Task"):
         """
         Bind existing Task to parent task
 
         :param parent: Task to bind to
```

## karton/system/system.py

```diff
@@ -99,28 +99,28 @@
             elif (
                 task.status == TaskState.DECLARED
                 and task.uid not in unrouted_task_uids
                 and task.last_update is not None
                 and current_time > task.last_update + self.task_dispatched_timeout
             ):
                 to_delete.append(task)
-                self.log.warning(
+                self.log.error(
                     "Task %s is in Dispatched state more than %d seconds. "
                     "Killed. (origin: %s)",
                     task.uid,
                     self.task_dispatched_timeout,
                     task.headers.get("origin", "<unknown>"),
                 )
             elif (
                 task.status == TaskState.STARTED
                 and task.last_update is not None
                 and current_time > task.last_update + self.task_started_timeout
             ):
                 to_delete.append(task)
-                self.log.warning(
+                self.log.error(
                     "Task %s is in Started state more than %d seconds. "
                     "Killed. (receiver: %s)",
                     task.uid,
                     self.task_started_timeout,
                     task.headers.get("receiver", "<unknown>"),
                 )
             elif task.status == TaskState.FINISHED:
```

## Comparing `karton_core-5.3.3-nspkg.pth` & `karton_core-5.3.4-nspkg.pth`

 * *Files identical despite different names*

## Comparing `karton_core-5.3.3.dist-info/LICENSE` & `karton_core-5.3.4.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `karton_core-5.3.3.dist-info/METADATA` & `karton_core-5.3.4.dist-info/METADATA`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: karton-core
-Version: 5.3.3
+Version: 5.3.4
 Summary: Distributed malware analysis orchestration framework
 Home-page: https://github.com/CERT-Polska/karton
 License: UNKNOWN
 Platform: UNKNOWN
 Classifier: Programming Language :: Python :: 3
 Classifier: Operating System :: OS Independent
 Classifier: License :: OSI Approved :: BSD License
```

## Comparing `karton_core-5.3.3.dist-info/RECORD` & `karton_core-5.3.4.dist-info/RECORD`

 * *Files 14% similar despite different names*

```diff
@@ -1,26 +1,26 @@
-karton_core-5.3.3-nspkg.pth,sha256=vHa-jm6pBTeInFrmnsHMg9AOeD88czzQy-6QCFbpRcM,539
+karton_core-5.3.4-nspkg.pth,sha256=vHa-jm6pBTeInFrmnsHMg9AOeD88czzQy-6QCFbpRcM,539
 karton/core/__init__.py,sha256=QuT0BWZyp799eY90tK3H1OD2hwuusqMJq8vQwpB3kG4,337
-karton/core/__version__.py,sha256=1nSgbQKO6KlKoDYLTNXC8iJUIO_SuORsK-CISssv5l0,22
+karton/core/__version__.py,sha256=dAiy67tSM_yYFR8Us_fQT-TDbfV34VpASYNKXfGmEnQ,22
 karton/core/backend.py,sha256=evOzlz1v1sxWusc8VojGAYyeyi9fcbVoEPm6WoNT1Xs,34696
 karton/core/base.py,sha256=C6Lco3E0XCsxvEjeVOLR9fxh_IWJ1vjC9BqUYsQyewE,8083
 karton/core/config.py,sha256=7oKchitq6pWzPuXRfjBXqVT_BgGIz2p-CDo1RGaNJQg,8118
 karton/core/exceptions.py,sha256=8i9WVzi4PinNlX10Cb-lQQC35Hl-JB5R_UKXa9AUKoQ,153
 karton/core/inspect.py,sha256=rIa0u4u12vG_RudPfc9UAS4RZD56W8qbUa8n1dDIkX0,4868
-karton/core/karton.py,sha256=-BWsNvbL_yFFlSPjEOXlBqkENEWLTfIB0ETjowh7Mjo,14863
+karton/core/karton.py,sha256=9SOAviG42kSsPqc3EuaHzWtA_KywMtc01hmU6FaJpHo,15007
 karton/core/logger.py,sha256=J3XAyG88U0cwYC9zR6E3QD1uJenrQh7zS9-HgxhqeAs,2040
 karton/core/main.py,sha256=ir1-dhn3vbwfh2YHiM6ZYfRBbjwLvJSz0d8tuK1mb_4,8310
 karton/core/py.typed,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 karton/core/resource.py,sha256=tA3y_38H9HVKIrCeAU70zHUkQUv0BuCQWMC470JLxxc,20321
-karton/core/task.py,sha256=1yyCH6A6MBJ7yuKECmsLrZDRECbKQ-48dJ31ZL7FR5Y,19644
+karton/core/task.py,sha256=WYXzVopg8VlWOc7ncEscHVKivsXHfZc5zWLHW_mxBwY,21000
 karton/core/test.py,sha256=tms-YM7sUKQDHN0vm2_W7DIvHnO_ld_VPsWHnsbKSfk,9102
 karton/core/utils.py,sha256=sEVqGdVPyYswWuVn8wYXBQmln8Az826N_2HgC__pmW8,4090
 karton/system/__init__.py,sha256=JF51OqRU_Y4c0unOulvmv1KzSHSq4ZpXU8ZsH4nefRM,63
 karton/system/__main__.py,sha256=QJkwIlSwaPRdzwKlNmCAL41HtDAa73db9MZKWmOfxGM,56
-karton/system/system.py,sha256=AsQLGF_8YI-o4dCOe2hyQefYlhGEguFSoPg1EcQtJyU,13791
-karton_core-5.3.3.dist-info/LICENSE,sha256=o8h7hYhn7BJC_-DmrfqWwLjaR_Gbe0TZOOQJuN2ca3I,1519
-karton_core-5.3.3.dist-info/METADATA,sha256=sumt5njKhDPynjbmFZvPxdPPSCCXR4wr3xchvowJPC8,6847
-karton_core-5.3.3.dist-info/WHEEL,sha256=G16H4A3IeoQmnOrYV4ueZGKSjhipXx8zc8nu9FGlvMA,92
-karton_core-5.3.3.dist-info/entry_points.txt,sha256=FJj5EZuvFP0LkagjX_dLbRGBUnuLjgBiSyiFfq4c86U,99
-karton_core-5.3.3.dist-info/namespace_packages.txt,sha256=X8SslCPsqXDCnGZqrYYolzT3xPzJMq1r-ZQSc0jfAEA,7
-karton_core-5.3.3.dist-info/top_level.txt,sha256=X8SslCPsqXDCnGZqrYYolzT3xPzJMq1r-ZQSc0jfAEA,7
-karton_core-5.3.3.dist-info/RECORD,,
+karton/system/system.py,sha256=65c8j1Ayra_CrXA1AQPBm00bTnpQiW91iZlTTRfJJI8,13787
+karton_core-5.3.4.dist-info/LICENSE,sha256=o8h7hYhn7BJC_-DmrfqWwLjaR_Gbe0TZOOQJuN2ca3I,1519
+karton_core-5.3.4.dist-info/METADATA,sha256=w15YiCEMDZrAF_429FAx98NH3tif38vyDxI9g9heY7E,6847
+karton_core-5.3.4.dist-info/WHEEL,sha256=G16H4A3IeoQmnOrYV4ueZGKSjhipXx8zc8nu9FGlvMA,92
+karton_core-5.3.4.dist-info/entry_points.txt,sha256=FJj5EZuvFP0LkagjX_dLbRGBUnuLjgBiSyiFfq4c86U,99
+karton_core-5.3.4.dist-info/namespace_packages.txt,sha256=X8SslCPsqXDCnGZqrYYolzT3xPzJMq1r-ZQSc0jfAEA,7
+karton_core-5.3.4.dist-info/top_level.txt,sha256=X8SslCPsqXDCnGZqrYYolzT3xPzJMq1r-ZQSc0jfAEA,7
+karton_core-5.3.4.dist-info/RECORD,,
```

